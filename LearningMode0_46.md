# nx\_intercept #

```
 $ python nx_intercept.py -h
Usage: python nx_intercept -c /path/to/conf [-h,--help]
[-a,--add-monitoring ip:1.2.3.4|md5:af794f5e532d7a4fa59c49845af7947e] [-l,--log-file /path/to/logfile]```

This is the learning daemon. It is used to record the triggered exceptions while naxsi is in learning mode.
It can also be used to fill the signature database with the content of a nginx error log file and to store HTTP requests based on the source ip or the exception hash (for now, the requests are only stored on the database, you can't see them in the web interface).


# nx\_extract #

```

$ python nx_extract.py
Usage : python nx_extract /path/to/conf/file```

This daemon is used to generate whitelists and to view miscellaneous stats about the exceptions.

# Setup #

Since naxsi 0.46, the daemons take the configuration file as a command-line argument.

This is an typical configuration file :

```

[mysql]

username=user
password=password
hostname=127.0.0.1
dbname=naxsi_sig

[nx_extract]

port = 8081
rules_path=/usr/local/nginx/sec-rules/core.rules

[nx_intercept]

port=8080```

The mysql section is mandatory.
If the the nx\_extract section or the nx\_intercept section are not present, or if some variables are not defined, default values will be used.

# Example #

In this example, the 2 daemons and nginx are running on localhost.

The nginx configuration :
```


server {
proxy_set_header Proxy-Connection "";
listen       *:80;
access_log  /tmp/nginx_access.log;
error_log  /tmp/nginx_error.log debug;

server_name blog.memze.ro;


location / {
include    /etc/nginx/memzero.rules;
proxy_pass http://88.191.133.106/;
proxy_set_header Host blog.memze.ro;
}


location /RequestDenied {
proxy_pass http://127.0.0.1:8080;
}
}
```
The naxsi configuration:

```

LearningMode;
SecRulesEnabled;
#SecRulesDisabled;
DeniedUrl "/RequestDenied";

## check rules
CheckRule "$SQL >= 8" BLOCK;
CheckRule "$RFI >= 8" BLOCK;
CheckRule "$TRAVERSAL >= 4" BLOCK;
CheckRule "$EVADE >= 4" BLOCK;
CheckRule "$XSS >= 8" BLOCK;
```

The naxsi-ui.conf :

```

[mysql]

username=user
password=password
hostname=127.0.0.1
dbname=naxsi_sig

[nx_extract]

port = 8081
rules_path=/usr/local/nginx/sec-rules/core.rules

[nx_intercept]

port=8080
```

nx\_intercept will listen on the port 8080 and nx\_extract on 8081.

All exceptions generated by naxsi will be redirect to nx\_intercept (See the /RequestDenied location, it does a proxy-pass to nx\_intercept) to be stored in the database.

If you navigate to 127.0.0.1:8081, you will see the naxsi web interface.
You can use it to generate whitelists and to view stats about the database (hits repartition, number of hits per day, etc).

# Usage #

Browse your website for a while in order to generate exceptions (just do normal navigation, don't try anything evil (SQL injection, XSS,...) or those attacks will be whitelisted !).

Once your browsing session is over, go to 127.0.0.1:8081.
You will land on naxsi web interface.

Go to the help section to see how to use this interface :


```

A GET request on /get_rules will display the generated rules. Non-optimised rules will be displayed in comment.```

You can also change the way the whitelist is created :
```

page_hit : Minimum number of pages triggering the same event before proposing the optimisation (ie, if there is more than 10 urls that trigger a rule, the rule will be whitelisted on every url).
Default to 10.

rules_hit : Minimum number of rules hitting the same event on the same page before proposing optimisation (ie, if there is more than 10 differents rules triggered on the same url, all rules will be whitelisted on that url)
Default to 10.```

Here, as my website has nothing special and only very few user interaction (and because I'm lazy), I will turn page\_hit to 3. This means, if a rules hits 3 different pages, I will turn it off for the whole site.
```

lynx --dump http://127.0.0.1:8081/get_rules?rules_hit=10&page_hit=3 ...
########### End Of Rules Before Optimisation ###########
BasicRule wl:1005 "mz:$HEADERS_VAR:cookie";
BasicRule wl:1010 "mz:$HEADERS_VAR:cookie";
BasicRule wl:1011 "mz:$HEADERS_VAR:cookie";
BasicRule wl:1308 "mz:$HEADERS_VAR:cookie";
BasicRule wl:1309 "mz:$HEADERS_VAR:cookie";
BasicRule wl:1315 "mz:$HEADERS_VAR:cookie";
```

Non optimised rules will be displayed as comment at the top of the page :

```

#BasicRule wl:1011 "mz:$URL:/|$HEADERS_VAR:cookie";
#2 hits on rule 1308 (parenthesis) on url / from 1 different peers
...
```

So you will know exactly what you allow and where.

Then, add this to your naxsi configuration file, turn off learning mode, reload nginx and voil√† your website is protected against the bad guys :)

# Learning Mode ? #

The global idea behind this is that naxsi will generate whitelists from your traffic while in learning mode. This will allow those to-be-blocked requests not to turn into false positives.

When it seems (and it generally does) possible, naxsi will factorize rules to limit learning mode length.

For example, if you have 10 generated whitelists like this :

```

BasicRule wl:1308 "mz:$URL:/page1|$HEADERS_VAR:cookie";
BasicRule wl:1308 "mz:$URL:/page2|$HEADERS_VAR:cookie";
BasicRule wl:1308 "mz:$URL:/page3|$HEADERS_VAR:cookie";
...```

You can safely suppose that this exception will be triggered in all pages, as it's in the cookie. When something like this happens, nx\_extract will propose you the following rule instead :

```

BasicRule wl:1308 "mz:$HEADERS_VAR:cookie";
```

Which means that you will disable rule 1308 on the cookie header, for 'all' pages.

Learning of 'free' user input forms is very important as well.

# More awesomeness with nx\_extract #

Ok, so nx\_extract allows you to see fancy graphics and stats about the exception triggered during the learning mode.
That's useful, but nx\_extract can do more !
Since you can specify the database name in the configuration file, and nx\_intercept can fill the database from nginx log, you can visualize stats of real attacks against your website !

Here's how to do it :

Create a new configuration file with a **different** database name :
```

[mysql]

username=user
password=password
hostname=127.0.0.1
dbname=naxsi_attack

[nx_extract]

port = 8081
rules_path=/usr/local/nginx/sec-rules/core.rules

[nx_intercept]

port=8080```

Now, we fill the database with data from nginx error log :

```

$ python nx_intercept.py -c naxsi-ui-attack.conf -l nginx-blog.memze.ro_error.log
Filling database with nginx-blog.memze.ro_error.log. ALL PREVIOUS CONTENT WILL BE DROPPED !!!
Done.
```

Be sure to specify the right configuration file because the database will be dropped and recreated to avoid redundant data.
Now, the database naxsi\_attack contains all the exceptions from the error log.

Then, launch nx\_extract :
```

$ python nx_extract.py naxsi-ui-attack.conf```

Navigate to 127.0.0.1:8081, go to the graph sections and admire the graphics :).


